async function fetchMessages() {
    const response = await fetch(`${backendUrl}/messages?since=${lastReceived}`);
    const data = await response.json();
    lastReceived = data.latestTimestamp;

    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = ""; // Clear the container before appending new messages

    data.messages.forEach((msg) => {
        let messageElement = document.createElement("div");
        messageElement.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text} <small>(${new Date(msg.timestamp).toLocaleTimeString()})</small>`;

        const token = localStorage.getItem("token");
        if (token) {
            const payload = JSON.parse(atob(token.split(".")[1]));
            if (payload.username === "Admin") {
                let deleteBtn = document.createElement("button");
                deleteBtn.innerText = "❌";
                deleteBtn.onclick = () => deleteMessage(msg.id);
                messageElement.appendChild(deleteBtn);
            }
        }

        messagesDiv.appendChild(messageElement);
    });
}

async function deleteMessage(messageId) {
    const token = localStorage.getItem("token");

    const response = await fetch(`${backendUrl}/delete`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json", 
            "Authorization": `Bearer ${token}` 
        },
        body: JSON.stringify({ id: messageId })
    });

    const data = await response.json();
    if (response.ok) {
        alert(data.message);
        fetchMessages();  // Re-fetch messages to update the list
    } else {
        alert(data.message);
    }
}
